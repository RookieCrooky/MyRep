name: Update and Convert servers.txt to Clash YAML

on:
  schedule:
    - cron: '0 0 * * *'  # –∑–∞–ø—É—Å–∫ —Ä–∞–∑ –≤ –¥–µ–Ω—å (UTC)
  workflow_dispatch:

permissions:
  contents: write  # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∑–∞–ø–∏—Å—å

jobs:
  update-servers:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip
        pip install pyyaml

    - name: Download servers.txt
      run: |
        curl -L -o servers.txt https://raw.githubusercontent.com/igareck/vpn-configs-for-russia/refs/heads/main/Vless-Reality-White-Lists-Rus-Mobile.txt

    - name: Convert servers.txt ‚Üí servers.yml
      run: |
        python3 <<'EOF'
        import yaml, base64, urllib.parse, re, json
        from collections import defaultdict
        
        def decode_base64(data):
            """–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ base64 —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º padding –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏"""
            try:
                missing_padding = len(data) % 4
                if missing_padding:
                    data += '=' * (4 - missing_padding)
                return base64.b64decode(data).decode('utf-8')
            except:
                return base64.b64decode(data).decode('utf-8', errors='ignore')
        
        def parse_vless(uri):
            """–ü–∞—Ä—Å–∏–Ω–≥ VLESS URI –≤ —Ñ–æ—Ä–º–∞—Ç Clash"""
            try:
                # –£–¥–∞–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å vless://
                uri = uri[8:]
                
                # –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ —á–∞—Å—Ç–∏
                uuid_part, rest = uri.split('@', 1)
                uuid = uuid_part.split(':')[0] if ':' in uuid_part else uuid_part
                
                # –†–∞–∑–¥–µ–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä:–ø–æ—Ä—Ç –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                server_port, params = rest.split('?', 1) if '?' in rest else (rest, '')
                server, port = server_port.split(':', 1)
                port = int(port)
                
                # –ü–∞—Ä—Å–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                params_dict = urllib.parse.parse_qs(params)
                
                # –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–∫—Å–∏
                proxy = {
                    "name": "",
                    "type": "vless",
                    "server": server,
                    "port": port,
                    "uuid": uuid,
                    "network": params_dict.get('type', ['tcp'])[0],
                    "udp": True
                }
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ TLS
                security = params_dict.get('security', [''])[0]
                if security in ['tls', 'reality']:
                    proxy['tls'] = True
                    proxy['servername'] = params_dict.get('sni', params_dict.get('host', ['']))[0]
                    
                    if security == 'reality':
                        proxy['reality-opts'] = {
                            "public-key": params_dict.get('pbk', [''])[0],
                            "short-id": params_dict.get('sid', [''])[0]
                        }
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ WS
                if proxy['network'] == 'ws':
                    proxy['ws-opts'] = {
                        "path": params_dict.get('path', ['/'])[0],
                        "headers": {
                            "Host": params_dict.get('host', params_dict.get('sni', ['']))[0]
                        } if params_dict.get('host') or params_dict.get('sni') else {}
                    }
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP/2
                elif proxy['network'] == 'h2':
                    proxy['h2-opts'] = {
                        "path": params_dict.get('path', ['/'])[0],
                        "host": [params_dict.get('host', params_dict.get('sni', ['']))[0]]
                    }
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ gRPC
                elif proxy['network'] == 'grpc':
                    proxy['grpc-opts'] = {
                        "grpc-service-name": params_dict.get('serviceName', [''])[0]
                    }
                
                return proxy
                
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ VLESS: {e}")
                return None
        
        def parse_vmess(uri):
            """–ü–∞—Ä—Å–∏–Ω–≥ VMESS URI –≤ —Ñ–æ—Ä–º–∞—Ç Clash"""
            try:
                # –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64
                decoded = decode_base64(uri[8:])
                config = json.loads(decoded)
                
                proxy = {
                    "name": config.get('ps', ''),
                    "type": "vmess",
                    "server": config.get('add', ''),
                    "port": int(config.get('port', 0)),
                    "uuid": config.get('id', ''),
                    "alterId": int(config.get('aid', 0)),
                    "cipher": config.get('scy', 'auto'),
                    "udp": True
                }
                
                # TLS
                if config.get('tls') == 'tls':
                    proxy['tls'] = True
                    proxy['servername'] = config.get('sni', config.get('host', ''))
                
                # Network type
                network = config.get('net', 'tcp')
                proxy['network'] = network
                
                # WS options
                if network == 'ws':
                    proxy['ws-opts'] = {
                        "path": config.get('path', '/'),
                        "headers": {
                            "Host": config.get('host', config.get('sni', ''))
                        } if config.get('host') or config.get('sni') else {}
                    }
                
                # HTTP/2
                elif network == 'h2':
                    proxy['h2-opts'] = {
                        "path": config.get('path', '/'),
                        "host": [config.get('host', config.get('sni', ''))]
                    }
                
                # gRPC
                elif network == 'grpc':
                    proxy['grpc-opts'] = {
                        "grpc-service-name": config.get('path', '').lstrip('/')
                    }
                
                return proxy
                
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ VMESS: {e}")
                return None
        
        def parse_ss(uri):
            """–ü–∞—Ä—Å–∏–Ω–≥ Shadowsocks URI"""
            try:
                if '#' in uri:
                    uri, name = uri.split('#', 1)
                    name = urllib.parse.unquote(name)
                else:
                    name = ''
                
                # –£–¥–∞–ª—è–µ–º ss://
                uri = uri[5:]
                
                if '@' in uri:
                    # –§–æ—Ä–º–∞—Ç: method:password@server:port
                    method_password, server_port = uri.split('@', 1)
                    method, password = method_password.split(':', 1)
                    server, port = server_port.split(':', 1)
                else:
                    # –§–æ—Ä–º–∞—Ç base64
                    decoded = decode_base64(uri)
                    method_password, server_port = decoded.split('@', 1)
                    method, password = method_password.split(':', 1)
                    server, port = server_port.split(':', 1)
                
                return {
                    "name": name,
                    "type": "ss",
                    "server": server,
                    "port": int(port),
                    "cipher": method,
                    "password": password,
                    "udp": True
                }
                
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ SS: {e}")
                return None
        
        def parse_trojan(uri):
            """–ü–∞—Ä—Å–∏–Ω–≥ Trojan URI"""
            try:
                if '#' in uri:
                    uri, name = uri.split('#', 1)
                    name = urllib.parse.unquote(name)
                else:
                    name = ''
                
                # –£–¥–∞–ª—è–µ–º trojan://
                uri = uri[9:]
                
                # –†–∞–∑–¥–µ–ª—è–µ–º –ø–∞—Ä–æ–ª—å –∏ –æ—Å—Ç–∞–ª—å–Ω–æ–µ
                password, rest = uri.split('@', 1)
                
                # –†–∞–∑–¥–µ–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä:–ø–æ—Ä—Ç –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                if '?' in rest:
                    server_port, params = rest.split('?', 1)
                    params_dict = urllib.parse.parse_qs(params)
                else:
                    server_port, params_dict = rest, {}
                
                server, port = server_port.split(':', 1)
                
                proxy = {
                    "name": name,
                    "type": "trojan",
                    "server": server,
                    "port": int(port),
                    "password": password,
                    "udp": True
                }
                
                # SNI
                if params_dict.get('sni'):
                    proxy['sni'] = params_dict['sni'][0]
                
                # Network
                network = params_dict.get('type', ['tcp'])[0]
                proxy['network'] = network
                
                # WS
                if network == 'ws':
                    proxy['ws-opts'] = {
                        "path": params_dict.get('path', ['/'])[0],
                        "headers": {
                            "Host": params_dict.get('host', params_dict.get('sni', ['']))[0]
                        } if params_dict.get('host') or params_dict.get('sni') else {}
                    }
                
                return proxy
                
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Trojan: {e}")
                return None
        
        def main():
            # –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            with open("servers.txt", "r", encoding="utf-8") as f:
                lines = [line.strip() for line in f if line.strip() and not line.startswith('#')]
            
            proxies = []
            name_counter = defaultdict(int)
            
            for i, line in enumerate(lines):
                proxy = None
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø—Ä–æ–∫—Å–∏
                if line.startswith('vless://'):
                    proxy = parse_vless(line)
                elif line.startswith('vmess://'):
                    proxy = parse_vmess(line)
                elif line.startswith('ss://'):
                    proxy = parse_ss(line)
                elif line.startswith('trojan://'):
                    proxy = parse_trojan(line)
                else:
                    print(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: {line[:50]}...")
                    continue
                
                if not proxy:
                    print(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä–æ–∫—É {i+1}")
                    continue
                
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏
                if not proxy.get('name'):
                    proxy['name'] = f"Server-{i+1}"
                
                # –û—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω–∏
                name = re.sub(r'[^\w\s\-\.]', '', proxy['name']).strip()
                if not name:
                    name = f"Server-{i+1}"
                
                # –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
                name_counter[name] += 1
                if name_counter[name] > 1:
                    name = f"{name}-{name_counter[name]}"
                
                proxy['name'] = name
                proxies.append(proxy)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –ø—Ä–æ–∫—Å–∏
            if not proxies:
                print("–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏")
                return
            
            # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Clash
            config = {
                "port": 7890,
                "socks-port": 7891,
                "allow-lan": False,
                "mode": "rule",
                "log-level": "info",
                "external-controller": "0.0.0.0:9090",
                "secret": "",
                "dns": {
                    "enable": True,
                    "listen": "0.0.0.0:53",
                    "default-nameserver": ["8.8.8.8", "1.1.1.1"],
                    "enhanced-mode": "fake-ip",
                    "fake-ip-range": "198.18.0.1/16",
                    "nameserver": [
                        "https://doh.pub/dns-query",
                        "https://dns.alidns.com/dns-query"
                    ],
                    "fallback": [
                        "https://doh.dns.sb/dns-query",
                        "https://dns.cloudflare.com/dns-query",
                        "https://dns.twnic.tw/dns-query"
                    ]
                },
                "proxies": proxies,
                "proxy-groups": [
                    {
                        "name": "üöÄ Auto Select",
                        "type": "url-test",
                        "url": "http://www.gstatic.com/generate_204",
                        "interval": 300,
                        "tolerance": 50,
                        "proxies": [p["name"] for p in proxies]
                    },
                    {
                        "name": "üîó Load Balance",
                        "type": "load-balance",
                        "url": "http://www.gstatic.com/generate_204",
                        "interval": 300,
                        "strategy": "consistent-hashing",
                        "proxies": [p["name"] for p in proxies]
                    },
                    {
                        "name": "üåê Global",
                        "type": "select",
                        "proxies": ["üöÄ Auto Select", "üîó Load Balance"] + [p["name"] for p in proxies]
                    }
                ],
                "rules": [
                  - GEOSITE,youtube,Global
                  - GEOSITE,openai,Global
                  - DOMAIN-SUFFIX,minesweeper.online,Global
                  - DOMAIN-SUFFIX,rutracker.org,Global
                  - DOMAIN-SUFFIX,rutracker.cc,Global
                  - DOMAIN-SUFFIX,habr.com,Global
                  - DOMAIN-SUFFIX,4pda.to,Global
                  - DOMAIN-SUFFIX,ifconfig.co,Global
                  - DOMAIN-SUFFIX,desmos.com,Global
                  - PROCESS-NAME,Discord.exe,Global
                  - DOMAIN-SUFFIX,discord.com,Global
                  - DOMAIN-SUFFIX,discordapp.com,Global
                  - DOMAIN-SUFFIX,discord.gg,Global
                  - DOMAIN-SUFFIX,discordmedia.net,Global
                  - DOMAIN-SUFFIX,discordapp.net,Global
                  - DOMAIN-SUFFIX,airspy.com,Global
                  - DOMAIN-SUFFIX,huggingface.co,Global
                  - MATCH,DIRECT
                ]
            }
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            with open("servers.yml", "w", encoding="utf-8") as f:
                yaml.dump(config, f, allow_unicode=True, sort_keys=False, default_flow_style=False, indent=2)
            
            print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ {len(proxies)} –ø—Ä–æ–∫—Å–∏")
            print("–§–∞–π–ª servers.yml —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ")
        
        if __name__ == "__main__":
            main()
        EOF

   
    - name: Commit and Push changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add servers.txt servers.yml
        git diff-index --quiet HEAD || git commit -m "Update servers.txt and generate servers.yml"
        git push  # –ü—Ä–æ—Å—Ç–æ git push, –±–µ–∑ URL
